<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>آجر - تطبيق الذكر والأدعية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        /* جميع الأنماط الأصلية تبقى كما هي */
        :root {
            --primary-color-default: #1a365d;
            --secondary-color-default: #2d3748;
            --accent-color-default: #cbd5e0;
            --text-color-default: #e2e8f0;
            --counter-color-default: #90cdf4;
            --reset-color-default: #e53e3e;
            --add-color-default: #3182ce;
            --vibration-color-default: #dd6b20;
            --card-bg-default: rgba(255,255,255,.08);
            --border-color-default: rgba(255,255,255,.1);
            --modal-bg-default: rgba(0,0,0,.5);
            --dua-icon-color: #38a169;
            --completed-color: #38a169;
            --category-bg-default: rgba(255,255,255,.05);
            --light-primary-color: #f7fafc;
            --light-secondary-color: #edf2f7;
            --light-text-color: #2d3748;
            --light-accent-color: #4a5568;
            --light-card-bg: rgba(255,255,255,.9);
            --light-border-color: rgba(0,0,0,.1);
            --light-modal-bg: rgba(255,255,255,.8);
            --light-category-bg: #fff;
            --theme-primary: var(--primary-color-default);
            --theme-secondary: var(--secondary-color-default);
            --theme-counter: var(--counter-color-default);
            --theme-reset: var(--reset-color-default);
            --theme-add: var(--add-color-default);
            --theme-accent: var(--accent-color-default);
            --theme-text: var(--text-color-default);
            --theme-card-bg: var(--card-bg-default);
            --theme-border-color: var(--border-color-default);
            --theme-vibration: var(--vibration-color-default);
            --modal-bg: var(--modal-bg-default);
            --category-bg: var(--category-bg-default);
            --icon-size: 24px;
            
            /* New Theme Colors - More Calm */
            --theme-purple-primary: #553c9a;
            --theme-purple-secondary: #6b46c1;
            --theme-purple-accent: #d6bcfa;
            
            --theme-blue-primary: #2c5282;
            --theme-blue-secondary: #4299e1;
            --theme-blue-accent: #bee3f8;
            
            --theme-green-primary: #276749;
            --theme-green-secondary: #48bb78;
            --theme-green-accent: #c6f6d5;
            
            --theme-rose-primary: #97266d;
            --theme-rose-secondary: #ed64a6;
            --theme-rose-accent: #fed7e2;
            
            --theme-sand-primary: #b7791f;
            --theme-sand-secondary: #ecc94b;
            --theme-sand-accent: #fefcbf;
            
            --theme-ocean-primary: #234e52;
            --theme-ocean-secondary: #38b2ac;
            --theme-ocean-accent: #b2f5ea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            padding-bottom: 80px;
            transition: background-color .5s ease, color .5s ease;
            overflow-x: hidden;
            text-align: right;
            position: relative;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
            color: var(--theme-text);
            -webkit-tap-highlight-color: transparent;
        }

        body.light-mode {
            --theme-primary: var(--light-primary-color);
            --theme-secondary: var(--light-secondary-color);
            --theme-text: var(--light-text-color);
            --theme-accent: var(--light-accent-color);
            --theme-card-bg: var(--light-card-bg);
            --theme-border-color: var(--light-border-color);
            --modal-bg: var(--light-modal-bg);
            --category-bg: var(--light-category-bg);
        }

        body.theme-purple {
            --theme-primary: var(--theme-purple-primary);
            --theme-secondary: var(--theme-purple-secondary);
            --theme-accent: var(--theme-purple-accent);
        }

        body.theme-blue {
            --theme-primary: var(--theme-blue-primary);
            --theme-secondary: var(--theme-blue-secondary);
            --theme-accent: var(--theme-blue-accent);
        }

        body.theme-green {
            --theme-primary: var(--theme-green-primary);
            --theme-secondary: var(--theme-green-secondary);
            --theme-accent: var(--theme-green-accent);
        }

        body.theme-rose {
            --theme-primary: var(--theme-rose-primary);
            --theme-secondary: var(--theme-rose-secondary);
            --theme-accent: var(--theme-rose-accent);
        }
        
        body.theme-sand {
            --theme-primary: var(--theme-sand-primary);
            --theme-secondary: var(--theme-sand-secondary);
            --theme-accent: var(--theme-sand-accent);
        }
        
        body.theme-ocean {
            --theme-primary: var(--theme-ocean-primary);
            --theme-secondary: var(--theme-ocean-secondary);
            --theme-accent: var(--theme-ocean-accent);
        }

        .container {
            width: 100%;
            max-width: 420px;
            background-color: var(--theme-card-bg);
            backdrop-filter: blur(25px) saturate(1.5);
            -webkit-backdrop-filter: blur(25px) saturate(1.5);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,.4);
            border: 2px solid var(--theme-border-color);
            transition: all .5s ease;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
            margin-bottom: auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        h1 {
            font-weight: 900;
            font-size: 1.8rem;
            color: var(--theme-accent);
        }

        /* Modern Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            display: flex;
            justify-content: space-around;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 12px;
            border: 1px solid var(--theme-border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .tab-bar.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(20px);
        }

        .tab-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--theme-text);
            opacity: 0.7;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 15px;
            flex: 1;
            max-width: 20%;
        }

        .tab-button:hover {
            opacity: 0.9;
            background-color: rgba(255,255,255,0.05);
        }

        .tab-button.active {
            opacity: 1;
            background-color: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .tab-button .tab-icon {
            width: 22px;
            height: 22px;
            margin-bottom: 5px;
            stroke: var(--theme-accent);
        }

        .tab-button.active .tab-icon {
            stroke: var(--theme-counter);
        }

        .tab-button .tab-label {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .tab-content.active {
            display: flex;
        }

        /* Counter Section */
        .counter-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px 0;
            min-height: 280px;
            flex-grow: 1;
        }

        .counter-display {
            font-size: 5.5rem;
            font-weight: 900;
            color: var(--theme-counter);
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255,255,255,.4), 0 5px 15px rgba(0,0,0,.2);
            transition: all .1s ease-out;
        }

        .dhikr-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--theme-accent);
            opacity: .95;
            min-height: 1.3em;
            padding: 0 10px;
        }

        .target-display {
            font-size: .9rem;
            font-weight: 600;
            color: var(--theme-accent);
            opacity: .8;
            margin-bottom: 15px;
            min-height: .9em;
        }

        .counter-button {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background-color: var(--theme-counter);
            border: 4px solid rgba(255,255,255,.3);
            color: var(--theme-primary);
            font-size: 1.4rem;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform .15s ease, box-shadow .2s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,.4), 0 0 20px var(--theme-counter);
            text-align: center;
            padding: 8px;
            user-select: none;
        }

        .counter-button:active {
            transform: scale(.92);
            box-shadow: 0 3px 8px rgba(0,0,0,.3);
        }

        .bottom-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .base-control {
            padding: 10px 16px;
            border: none;
            border-radius: 25px;
            font-size: .85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,.1);
            text-align: center;
            color: var(--theme-text);
            background-color: rgba(255,255,255,.1);
            border: 1px solid var(--theme-border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            text-decoration: none;
        }

        .base-control:hover {
            background-color: rgba(255,255,255,.15);
            transform: translateY(-1px);
        }

        .reset-button {
            background-color: var(--theme-reset);
            color: #fff;
        }

        .control-row {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        /* Duas Section */
        .duas-category-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            padding-bottom: 20px;
            max-height: 400px;
        }

        .dua-category-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 15px 20px;
            background-color: var(--category-bg);
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform .2s ease, background-color .2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            gap: 15px;
            text-align: right;
            border: 1px solid var(--theme-border-color);
        }

        .dua-category-item:hover {
            transform: translateY(-3px);
            background-color: rgba(255,255,255,.1);
        }

        .dua-category-item .icon {
            stroke: var(--dua-icon-color);
        }

        /* Quran Section - New Design */
        .quran-surah-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            padding-bottom: 20px;
            max-height: 400px;
        }

        .quran-surah-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 15px 20px;
            background-color: var(--category-bg);
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform .2s ease, background-color .2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            gap: 15px;
            text-align: right;
            border: 1px solid var(--theme-border-color);
        }

        .quran-surah-item:hover {
            transform: translateY(-3px);
            background-color: rgba(255,255,255,.1);
        }

        .quran-reader-view {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            padding-bottom: 20px;
        }

        .quran-page {
            background-color: #f8f3e6;
            color: #2c3e50;
            padding: 25px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-family: 'Amiri', serif;
            line-height: 2.2;
            text-align: justify;
            position: relative;
            min-height: 500px;
            margin-bottom: 15px;
            border: 1px solid #d4b98a;
        }

        .quran-page-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d4b98a;
        }

        .quran-surah-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c5530;
            margin-bottom: 5px;
        }

        .quran-surah-info {
            font-size: 1rem;
            color: #7a6a51;
        }

        .quran-ayat-container {
            font-size: 1.6rem;
            line-height: 2.5;
            text-align: right;
            margin-bottom: 10px;
        }

        .quran-ayat {
            margin-bottom: 15px;
            position: relative;
            padding-right: 40px;
            transition: background-color 0.3s ease;
        }

        .quran-ayat.bookmarked {
            background-color: rgba(56, 161, 105, 0.1);
            border-radius: 5px;
            padding: 5px;
        }

        .quran-ayat-number {
            position: absolute;
            right: 0;
            top: 0;
            width: 30px;
            height: 30px;
            background-color: #2c5530;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-family: 'Tajawal', sans-serif;
        }

        .quran-page-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #d4b98a;
            font-size: 0.9rem;
            color: #7a6a51;
        }

        .quran-nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .quran-nav-button {
            background-color: var(--theme-add);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: background-color .2s ease, transform .1s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quran-nav-button:disabled {
            background-color: var(--theme-secondary);
            cursor: not-allowed;
            opacity: .6;
        }

        .quran-nav-button:active {
            transform: scale(.95);
        }

        /* أزرار القرآن العائمة */
        .quran-exit-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--theme-reset);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1002;
            transition: transform 0.2s ease;
        }

        .quran-exit-button:hover {
            transform: scale(1.05);
        }

        .quran-exit-button:active {
            transform: scale(0.95);
        }

        .quran-floating-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
        }

        .quran-floating-button {
            background-color: var(--theme-add);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }

        .quran-floating-button:hover {
            transform: scale(1.05);
        }

        .quran-floating-button:active {
            transform: scale(0.95);
        }

        .quick-jump-label {
            position: fixed;
            top: 195px;
            right: 15px;
            font-size: 0.7rem;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 3px 8px;
            border-radius: 10px;
            z-index: 1001;
            text-align: center;
            width: 60px;
        }

        /* Prayer Times Section */
        .prayer-times-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .prayer-time-card {
            background-color: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--theme-border-color);
            transition: all 0.3s ease;
        }

        .prayer-time-card.active {
            background-color: rgba(74, 222, 128, 0.2);
            border-color: rgba(74, 222, 128, 0.5);
            transform: scale(1.05);
        }

        .prayer-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--theme-accent);
            margin-bottom: 5px;
        }

        .prayer-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--theme-counter);
        }

        .location-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--theme-accent);
        }

        .time-format-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .format-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 15px;
            background-color: rgba(255,255,255,0.1);
            color: var(--theme-text);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }

        .format-btn.active {
            background-color: var(--theme-add);
            color: white;
        }

        /* Statistics Section */
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .stat-card {
            background-color: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--theme-border-color);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--theme-counter);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: .8rem;
            color: var(--theme-accent);
            opacity: .8;
        }

        .daily-goal-section {
            background-color: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid var(--theme-border-color);
        }

        .goal-progress {
            width: 100%;
            height: 8px;
            background-color: rgba(0,0,0,.2);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--theme-add), var(--theme-counter));
            border-radius: 4px;
            transition: width .3s ease;
        }

        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: var(--completed-color);
            color: #fff;
            border-radius: 15px;
            font-size: .7rem;
            font-weight: 600;
            margin: 5px;
        }

        /* Settings Section */
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--category-bg);
            border-radius: 15px;
            border: 1px solid var(--theme-border-color);
        }

        .setting-label {
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--theme-add);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .theme-option.active {
            border-color: var(--theme-accent);
            transform: scale(1.1);
        }

        .theme-default { background: linear-gradient(135deg, #1a365d, #2d3748); }
        .theme-purple { background: linear-gradient(135deg, #553c9a, #6b46c1); }
        .theme-blue { background: linear-gradient(135deg, #2c5282, #4299e1); }
        .theme-green { background: linear-gradient(135deg, #276749, #48bb78); }
        .theme-rose { background: linear-gradient(135deg, #97266d, #ed64a6); }
        .theme-sand { background: linear-gradient(135deg, #b7791f, #ecc94b); }
        .theme-ocean { background: linear-gradient(135deg, #234e52, #38b2ac); }

        .charity-section {
            background-color: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid var(--theme-border-color);
            text-align: center;
        }

        .charity-text {
            font-size: 0.8rem;
            color: var(--theme-accent);
            opacity: 0.8;
            line-height: 1.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 100;
            justify-content: center;
            align-items: center;
            animation: fadeInModal .2s ease-out;
        }

        .modal-content {
            background-color: var(--theme-secondary);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,.4);
            border: 1px solid var(--theme-border-color);
            animation: slideInModal .3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeInModal {
            from { opacity: 0 }
            to { opacity: 1 }
        }

        @keyframes slideInModal {
            from { transform: translateY(50px); opacity: 0 }
            to { transform: translateY(0); opacity: 1 }
        }

        .modal-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--theme-accent);
            font-weight: 700;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-button {
            padding: 8px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s ease;
            font-size: .9rem;
        }

        .modal-confirm {
            background-color: #10b981;
            color: #fff;
        }

        .modal-cancel {
            background-color: var(--theme-reset);
            color: #fff;
        }

        .add-modal-input {
            width: 100%;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid var(--theme-border-color);
            background-color: rgba(0,0,0,.1);
            color: var(--theme-text);
            font-size: 1rem;
            text-align: right;
            box-sizing: border-box;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            right: 50%;
            transform: translateX(50%);
            background-color: #10b981;
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s ease, transform .3s ease;
            z-index: 200;
            font-weight: 600;
            text-align: center;
            direction: rtl;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(50%) translateY(-10px);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid var(--theme-border-color);
            background-color: rgba(0,0,0,.1);
            color: var(--theme-text);
            font-size: 1rem;
            text-align: right;
            box-sizing: border-box;
        }

        .daily-timer {
            background-color: rgba(255,255,255,.05);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid var(--theme-border-color);
            text-align: center;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--theme-counter);
            margin: 10px 0;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--theme-accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-label {
            font-size: 0.9rem;
            color: var(--theme-accent);
        }

        @media (max-width:600px){
            .container {
                padding: 15px;
                max-width: 95%;
                gap: 12px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .counter-display {
                font-size: 4.8rem;
            }
            .counter-button {
                width: 140px;
                height: 140px;
                font-size: 1.2rem;
            }
            .dhikr-name {
                font-size: 1.2rem;
            }
            .tab-bar {
                padding: 10px;
                width: 95%;
            }
            .tab-button {
                padding: 6px 8px;
            }
            .tab-button .tab-icon {
                width: 18px;
                height: 18px;
            }
            .tab-button .tab-label {
                font-size: 0.65rem;
            }
            .quran-floating-button, .quran-exit-button {
                width: 45px;
                height: 45px;
            }
            .quran-ayat-container {
                font-size: 1.4rem;
            }
            .prayer-times-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width:400px){
            .prayer-times-grid {
                grid-template-columns: 1fr;
            }
            .counter-button {
                width: 130px;
                height: 130px;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div class="header">
            <h1>آجر</h1>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content active" id="counter-tab">
            <div class="counter-area">
                <div class="counter-display" id="counter">0</div>
                <div class="dhikr-name" id="dhikr-name">استغفر الله</div>
                <div class="target-display" id="target-display">الهدف: لا يوجد</div>
                <button class="counter-button" id="counter-button">آجر</button>
            </div>
            <div class="bottom-controls">
                <div class="control-row">
                    <button class="base-control" id="select-dhikr-button" style="flex: 1;">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: white;">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        <span>اختر ذكرًا</span>
                    </button>
                    <button class="base-control" id="set-target-button" style="flex: 1;">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: var(--theme-accent);">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v-4m0-4v-.5"></path>
                            <path d="M12 7a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"></path>
                        </svg>
                        <span>تعيين الهدف</span>
                    </button>
                </div>
                <div class="control-row">
                    <button class="base-control" id="add-dhikr-button" style="flex: 1; background-color: var(--theme-add); color: white;">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: white;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span>أضف ذكر</span>
                    </button>
                    <button class="base-control reset-button" id="reset-button" style="flex: 1;">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: white;">
                            <path d="M20 12v-1c0-4.42-3.58-8-8-8S4 6.58 4 11s3.58 8 8 8c.7 0 1.39-.08 2.05-.24"/>
                            <path d="M19 16l3 3-3 3"/>
                            <path d="M22 19h-5"/>
                        </svg>
                        <span>تصفير العداد</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="duas-tab">
            <input type="text" id="duas-search-input" class="search-input" placeholder="ابحث في الأدعية..." dir="rtl">
            <div class="duas-category-list" id="duas-category-list">
                <!-- سيتم تعبئة الأدعية ديناميكياً -->
            </div>
        </div>
        
        <div class="tab-content" id="quran-tab">
            <input type="text" id="quran-search-input" class="search-input" placeholder="ابحث في القرآن..." dir="rtl">
            <div class="quran-surah-list" id="quran-surah-list">
                <!-- سيتم تعبئة قائمة السور ديناميكياً -->
            </div>
            <div class="quran-reader-view" id="quran-reader-view">
                <div class="quran-page" id="quran-page">
                    <!-- سيتم تعبئة صفحة القرآن ديناميكياً -->
                </div>
                <div class="quran-nav-buttons">
                    <button class="quran-nav-button" id="prev-ayah-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        الآية السابقة
                    </button>
                    <button class="quran-nav-button" id="next-ayah-button">
                        الآية التالية
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="prayer-tab">
            <div class="location-info" id="location-info">
                جاري تحديد الموقع...
            </div>
            <div class="time-format-toggle">
                <button class="format-btn active" data-format="12">12 ساعة</button>
                <button class="format-btn" data-format="24">24 ساعة</button>
            </div>
            <div class="prayer-times-grid" id="prayer-times-grid">
                <!-- سيتم تعبئة مواقيت الصلاة ديناميكياً -->
            </div>
            <div class="charity-section">
                <div class="charity-text">
                    هذا التطبيق صدقة جارية لصاحبه ووالديه
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="statistics-tab">
            <div class="statistics-grid">
                <div class="stat-card">
                    <div class="stat-value" id="today-count">0</div>
                    <div class="stat-label">الأذكار اليوم</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">إجمالي الأذكار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-dhikr">0</div>
                    <div class="stat-label">الأذكار المكتملة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bookmarked-ayat">0</div>
                    <div class="stat-label">الآيات المحددة</div>
                </div>
            </div>
            
            <div class="daily-goal-section">
                <h3 style="margin-bottom: 10px;">الهدف اليومي</h3>
                <div class="goal-progress">
                    <div class="goal-progress-bar" id="goal-progress-bar" style="width: 0%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: .8rem;">
                    <span id="goal-progress-text">0 / 0</span>
                    <span id="goal-percentage">0%</span>
                </div>
            </div>
            
            <div class="daily-timer">
                <h3 style="margin-bottom: 10px;">مؤتمر الورد اليومي</h3>
                <div class="timer-display" id="daily-timer">00:00:00</div>
                <div class="timer-controls">
                    <button class="base-control" id="start-timer-button">بدء</button>
                    <button class="base-control reset-button" id="reset-timer-button">إعادة تعيين</button>
                </div>
            </div>
            
            <div class="achievements-section">
                <h3 style="margin-bottom: 10px;">الإنجازات</h3>
                <div id="achievements-list">
                    <!-- سيتم تعبئة الإنجازات ديناميكياً -->
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="settings-section">
                <div class="setting-item">
                    <div class="setting-label">الوضع الليلي</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">الاهتزاز عند العد</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="vibration-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">اللغة الإنجليزية</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="english-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">تحديد الهدف اليومي</div>
                    <input type="number" id="daily-goal-input" class="add-modal-input" placeholder="عدد الأذكار اليومي" min="1" max="1000">
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">اختيار الثيم</div>
                    <div class="theme-selector">
                        <div class="theme-option theme-default active" data-theme="default"></div>
                        <div class="theme-option theme-purple" data-theme="purple"></div>
                        <div class="theme-option theme-blue" data-theme="blue"></div>
                        <div class="theme-option theme-green" data-theme="green"></div>
                        <div class="theme-option theme-rose" data-theme="rose"></div>
                        <div class="theme-option theme-sand" data-theme="sand"></div>
                        <div class="theme-option theme-ocean" data-theme="ocean"></div>
                    </div>
                </div>
                
                <div class="charity-section">
                    <div class="charity-text">
                        هذا التطبيق صدقة جارية لصاحبه ووالديه وأهل بيته
                        <br>اللهم تقبل منهم وأجعل هذا العمل في ميزان حسناتهم
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab Bar -->
    <div class="tab-bar" id="tab-bar">
        <button class="tab-button active" data-tab="counter-tab">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="tab-label">عداد</span>
        </button>
        <button class="tab-button" data-tab="duas-tab">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span class="tab-label">أدعية</span>
        </button>
        <button class="tab-button" data-tab="quran-tab">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
            <span class="tab-label">القرآن</span>
        </button>
        <button class="tab-button" data-tab="prayer-tab">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span class="tab-label">مواقيت</span>
        </button>
        <button class="tab-button" data-tab="settings-tab">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <span class="tab-label">الإعدادات</span>
        </button>
    </div>
    
    <!-- زر الخروج من السورة -->
    <button class="quran-exit-button" id="quran-exit-button" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
    </button>
    
    <!-- أزرار القرآن العائمة -->
    <div class="quran-floating-buttons" id="quran-floating-buttons" style="display: none;">
        <button class="quran-floating-button" id="bookmark-position-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
        </button>
        <button class="quran-floating-button" id="quick-jump-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </button>
        <div class="quick-jump-label" id="quick-jump-label">آخر موضع</div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Modals -->
    <div class="modal" id="select-dhikr-modal">
        <div class="modal-content">
            <div class="modal-title">اختر ذكرًا</div>
            <div id="dhikr-list">
                <!-- سيتم تعبئة قائمة الأذكار ديناميكياً -->
            </div>
            <div class="modal-buttons">
                <button class="modal-button modal-cancel" id="close-dhikr-modal">إغلاق</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="set-target-modal">
        <div class="modal-content">
            <div class="modal-title">تعيين هدف</div>
            <input type="number" id="target-input" class="add-modal-input" placeholder="عدد الأذكار المطلوبة" min="1" max="1000">
            <div class="modal-buttons">
                <button class="modal-button modal-confirm" id="confirm-target-button">تأكيد</button>
                <button class="modal-button modal-cancel" id="cancel-target-button">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="add-dhikr-modal">
        <div class="modal-content">
            <div class="modal-title">إضافة ذكر جديد</div>
            <input type="text" id="new-dhikr-name" class="add-modal-input" placeholder="اسم الذكر" dir="rtl">
            <div class="modal-buttons">
                <button class="modal-button modal-confirm" id="confirm-add-dhikr-button">إضافة</button>
                <button class="modal-button modal-cancel" id="cancel-add-dhikr-button">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="reset-confirm-modal">
        <div class="modal-content">
            <div class="modal-title">هل أنت متأكد من تصفير العداد؟</div>
            <div class="modal-buttons">
                <button class="modal-button modal-confirm" id="confirm-reset-button">نعم</button>
                <button class="modal-button modal-cancel" id="cancel-reset-button">لا</button>
            </div>
        </div>
    </div>

    <script>
        // البيانات الأساسية للتطبيق
        const appData = {
            counter: 0,
            currentDhikr: 'استغفر الله',
            target: 0,
            selectedSurah: null,
            currentAyah: 1,
            bookmarkedAyat: [],
            dailyGoal: 100,
            timerRunning: false,
            timerSeconds: 0,
            timerInterval: null,
            isEnglishEnabled: false,
            lastReadPosition: null,
            timeFormat: '12', // 12 or 24 hour format
            achievements: [
                { id: 1, name: 'مبتدئ', description: 'أكمل 10 أذكار', completed: false, target: 10 },
                { id: 2, name: 'منتظم', description: 'أكمل 50 ذكرًا', completed: false, target: 50 },
                { id: 3, name: 'مثابر', description: 'أكمل 100 ذكر', completed: false, target: 100 },
                { id: 4, name: 'مجاهد', description: 'أكمل 500 ذكر', completed: false, target: 500 },
                { id: 5, name: 'قارئ', description: 'حدد 5 آيات', completed: false, target: 5 },
                { id: 6, name: 'حافظ', description: 'حدد 10 آيات', completed: false, target: 10 }
            ]
        };

        // بيانات الأذكار
        const dhikrData = [
            { id: 1, name: 'استغفر الله', arabic: 'استغفر الله', count: 0 },
            { id: 2, name: 'سبحان الله', arabic: 'سبحان الله', count: 0 },
            { id: 3, name: 'الحمد لله', arabic: 'الحمد لله', count: 0 },
            { id: 4, name: 'الله أكبر', arabic: 'الله أكبر', count: 0 },
            { id: 5, name: 'لا إله إلا الله', arabic: 'لا إله إلا الله', count: 0 },
            { id: 6, name: 'لا حول ولا قوة إلا بالله', arabic: 'لا حول ولا قوة إلا بالله', count: 0 },
            { id: 7, name: 'أستغفر الله وأتوب إليه', arabic: 'أستغفر الله وأتوب إليه', count: 0 },
            { id: 8, name: 'سبحان الله وبحمده', arabic: 'سبحان الله وبحمده', count: 0 },
            { id: 9, name: 'سبحان الله العظيم', arabic: 'سبحان الله العظيم', count: 0 }
        ];

        // بيانات الأدعية المحلية الموسعة
        const localDuasData = [
            {
                id: 1,
                name: 'أذكار الصباح',
                duas: [
                    {
                        id: 101,
                        arabic: 'أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لاَ إِلَهَ إِلاَّ اللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ. رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذَا الْيَوْمِ وَخَيْرَ مَا بَعْدَهُ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذَا الْيَوْمِ وَشَرِّ مَا بَعْدَهُ، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ، وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ',
                        translation: 'أصبحنا وأصبح الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير. رب أسألك خير ما في هذا اليوم وخير ما بعده، وأعوذ بك من شر ما في هذا اليوم وشر ما بعده، رب أعوذ بك من الكسل، وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر'
                    },
                    {
                        id: 102,
                        arabic: 'اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ',
                        translation: 'اللهم بك أصبحنا، وبك أمسينا، وبك نحيا، وبك نموت، وإليك النشور'
                    },
                    {
                        id: 103,
                        arabic: 'اللَّهُمَّ أَنْتَ رَبِّي لا إِلَهَ إِلا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لا يَغْفِرُ الذُّنُوبَ إِلا أَنْتَ',
                        translation: 'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي فإنه لا يغفر الذنوب إلا أنت'
                    }
                ]
            },
            {
                id: 2,
                name: 'أذكار المساء',
                duas: [
                    {
                        id: 201,
                        arabic: 'أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لاَ إِلَهَ إِلاَّ اللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ. رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذِهِ اللَّيْلَةِ وَخَيْرَ مَا بَعْدَهَا، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذِهِ اللَّيْلَةِ وَشَرِّ مَا بَعْدَهَا، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ، وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ',
                        translation: 'أمسينا وأمسى الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير. رب أسألك خير ما في هذه الليلة وخير ما بعدها، وأعوذ بك من شر ما في هذه الليلة وشر ما بعدها، رب أعوذ بك من الكسل، وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر'
                    },
                    {
                        id: 202,
                        arabic: 'اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ الْمَصِيرُ',
                        translation: 'اللهم بك أمسينا، وبك أصبحنا، وبك نحيا، وبك نموت، وإليك المصير'
                    }
                ]
            },
            {
                id: 3,
                name: 'أدعية متنوعة',
                duas: [
                    {
                        id: 301,
                        arabic: 'رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ',
                        translation: 'ربنا آتنا في الدنيا حسنة وفي الآخرة حسنة وقنا عذاب النار'
                    },
                    {
                        id: 302,
                        arabic: 'رَبَّنَا اغْفِرْ لَنَا وَلإِخْوَانِنَا الَّذِينَ سَبَقُونَا بِالإِيمَانِ وَلا تَجْعَلْ فِي قُلُوبِنَا غِلاً لِّلَّذِينَ آمَنُوا رَبَّنَا إِنَّكَ رَؤُوفٌ رَّحِيمٌ',
                        translation: 'ربنا اغفر لنا ولإخواننا الذين سبقونا بالإيمان ولا تجعل في قلوبنا غلاً للذين آمنوا ربنا إنك رؤوف رحيم'
                    },
                    {
                        id: 303,
                        arabic: 'اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا، وَرِزْقًا طَيِّبًا، وَعَمَلاً مُتَقَبَّلاً',
                        translation: 'اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً'
                    }
                ]
            }
        ];

        // API للقرآن الكريم
        const QURAN_API_BASE = 'https://api.alquran.cloud/v1';
        
        // API لمواقيت الصلاة (Aladhan API)
        const PRAYER_API_BASE = 'https://api.aladhan.com/v1';
        
        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadData();
            renderDhikrList();
            loadDuasCategories(); // تحميل الأدعية المحلية بدلاً من API
            loadQuranSurahs();
            updateStatistics();
            updateGoalProgress();
            renderAchievements();
            loadPrayerTimes();
        });

        // تهيئة التطبيق
        function initializeApp() {
            // تعيين التاريخ الحالي لتتبع الأذكار اليومية
            const today = new Date().toDateString();
            if (!localStorage.getItem('lastDate') || localStorage.getItem('lastDate') !== today) {
                localStorage.setItem('lastDate', today);
                resetTodayCount();
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أزرار التبويب
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // زر العداد
            document.getElementById('counter-button').addEventListener('click', incrementCounter);

            // أزرار التحكم
            document.getElementById('select-dhikr-button').addEventListener('click', showDhikrModal);
            document.getElementById('set-target-button').addEventListener('click', showTargetModal);
            document.getElementById('add-dhikr-button').addEventListener('click', showAddDhikrModal);
            document.getElementById('reset-button').addEventListener('click', showResetConfirmModal);

            // أزرار الإغلاق في النوافذ المنبثقة
            document.getElementById('close-dhikr-modal').addEventListener('click', closeDhikrModal);
            document.getElementById('cancel-target-button').addEventListener('click', closeTargetModal);
            document.getElementById('confirm-target-button').addEventListener('click', setTarget);
            document.getElementById('cancel-add-dhikr-button').addEventListener('click', closeAddDhikrModal);
            document.getElementById('confirm-add-dhikr-button').addEventListener('click', addNewDhikr);
            document.getElementById('confirm-reset-button').addEventListener('click', resetCounter);
            document.getElementById('cancel-reset-button').addEventListener('click', closeResetConfirmModal);

            // زر الخروج من السورة
            document.getElementById('quran-exit-button').addEventListener('click', exitQuranView);

            // زر حفظ الموضع
            document.getElementById('bookmark-position-button').addEventListener('click', bookmarkCurrentPosition);

            // زر الانتقال السريع
            document.getElementById('quick-jump-button').addEventListener('click', quickJumpToBookmark);

            // البحث في الأدعية والقرآن
            document.getElementById('duas-search-input').addEventListener('input', filterDuas);
            document.getElementById('quran-search-input').addEventListener('input', filterQuran);

            // مؤقت الورد اليومي
            document.getElementById('start-timer-button').addEventListener('click', toggleTimer);
            document.getElementById('reset-timer-button').addEventListener('click', resetTimer);

            // الإعدادات
            document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
            document.getElementById('vibration-toggle').addEventListener('change', toggleVibration);
            document.getElementById('english-toggle').addEventListener('change', toggleEnglish);
            document.getElementById('daily-goal-input').addEventListener('change', setDailyGoal);

            // اختيار الثيم
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });

            // التنقل بين الآيات
            document.getElementById('prev-ayah-button').addEventListener('click', goToPrevAyah);
            document.getElementById('next-ayah-button').addEventListener('click', goToNextAyah);

            // تنسيق الوقت
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const format = this.getAttribute('data-format');
                    changeTimeFormat(format, this);
                });
            });
        }

        // تحميل البيانات من localStorage
        function loadData() {
            const savedCounter = localStorage.getItem('counter');
            const savedCurrentDhikr = localStorage.getItem('currentDhikr');
            const savedTarget = localStorage.getItem('target');
            const savedBookmarkedAyat = localStorage.getItem('bookmarkedAyat');
            const savedDailyGoal = localStorage.getItem('dailyGoal');
            const savedDhikrData = localStorage.getItem('dhikrData');
            const savedAchievements = localStorage.getItem('achievements');
            const savedTimerSeconds = localStorage.getItem('timerSeconds');
            const savedEnglishEnabled = localStorage.getItem('englishEnabled');
            const savedLastReadPosition = localStorage.getItem('lastReadPosition');
            const savedTimeFormat = localStorage.getItem('timeFormat');

            if (savedCounter) appData.counter = parseInt(savedCounter);
            if (savedCurrentDhikr) appData.currentDhikr = savedCurrentDhikr;
            if (savedTarget) appData.target = parseInt(savedTarget);
            if (savedBookmarkedAyat) appData.bookmarkedAyat = JSON.parse(savedBookmarkedAyat);
            if (savedDailyGoal) appData.dailyGoal = parseInt(savedDailyGoal);
            if (savedDhikrData) Object.assign(dhikrData, JSON.parse(savedDhikrData));
            if (savedAchievements) appData.achievements = JSON.parse(savedAchievements);
            if (savedTimerSeconds) appData.timerSeconds = parseInt(savedTimerSeconds);
            if (savedEnglishEnabled) appData.isEnglishEnabled = JSON.parse(savedEnglishEnabled);
            if (savedLastReadPosition) appData.lastReadPosition = JSON.parse(savedLastReadPosition);
            if (savedTimeFormat) appData.timeFormat = savedTimeFormat;

            updateCounterDisplay();
            updateTargetDisplay();
            updateDailyTimerDisplay();
            
            // تحديث تبديل اللغة الإنجليزية
            document.getElementById('english-toggle').checked = appData.isEnglishEnabled;
            
            // تحديث تنسيق الوقت
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-format') === appData.timeFormat) {
                    btn.classList.add('active');
                }
            });
        }

        // حفظ البيانات في localStorage
        function saveData() {
            localStorage.setItem('counter', appData.counter);
            localStorage.setItem('currentDhikr', appData.currentDhikr);
            localStorage.setItem('target', appData.target);
            localStorage.setItem('bookmarkedAyat', JSON.stringify(appData.bookmarkedAyat));
            localStorage.setItem('dailyGoal', appData.dailyGoal);
            localStorage.setItem('dhikrData', JSON.stringify(dhikrData));
            localStorage.setItem('achievements', JSON.stringify(appData.achievements));
            localStorage.setItem('timerSeconds', appData.timerSeconds);
            localStorage.setItem('englishEnabled', JSON.stringify(appData.isEnglishEnabled));
            localStorage.setItem('lastReadPosition', JSON.stringify(appData.lastReadPosition));
            localStorage.setItem('timeFormat', appData.timeFormat);
        }

        // تبديل التبويبات
        function switchTab(tabId) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // إلغاء تفعيل جميع أزرار التبويب
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // إظهار المحتوى المحدد وتفعيل الزر
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

            // إظهار/إخفاء الأزرار العائمة
            if (tabId === 'quran-tab' && appData.selectedSurah) {
                document.getElementById('tab-bar').classList.add('hidden');
                document.getElementById('quran-exit-button').style.display = 'flex';
                document.getElementById('quran-floating-buttons').style.display = 'flex';
            } else {
                document.getElementById('tab-bar').classList.remove('hidden');
                document.getElementById('quran-exit-button').style.display = 'none';
                document.getElementById('quran-floating-buttons').style.display = 'none';
            }
        }

        // زيادة العداد
        function incrementCounter() {
            appData.counter++;
            updateCounterDisplay();
            
            // تحديث إحصائيات الذكر الحالي
            const currentDhikr = dhikrData.find(d => d.name === appData.currentDhikr);
            if (currentDhikr) {
                currentDhikr.count++;
            }
            
            // الاهتزاز إذا كان مفعلاً
            if (document.getElementById('vibration-toggle').checked && navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // التحقق من تحقيق الهدف
            if (appData.target > 0 && appData.counter >= appData.target) {
                showToast('🎉 مبروك! لقد حققت هدفك اليوم!');
            }
            
            // التحقق من الإنجازات
            checkAchievements();
            
            // حفظ البيانات
            saveData();
            updateStatistics();
            updateGoalProgress();
        }

        // تحديث عرض العداد
        function updateCounterDisplay() {
            document.getElementById('counter').textContent = appData.counter;
            document.getElementById('dhikr-name').textContent = appData.currentDhikr;
        }

        // تحديث عرض الهدف
        function updateTargetDisplay() {
            const targetDisplay = document.getElementById('target-display');
            if (appData.target > 0) {
                targetDisplay.textContent = `الهدف: ${appData.target}`;
            } else {
                targetDisplay.textContent = 'الهدف: لا يوجد';
            }
        }

        // عرض نافذة اختيار الذكر
        function showDhikrModal() {
            document.getElementById('select-dhikr-modal').style.display = 'flex';
        }

        // إغلاق نافذة اختيار الذكر
        function closeDhikrModal() {
            document.getElementById('select-dhikr-modal').style.display = 'none';
        }

        // عرض نافذة تعيين الهدف
        function showTargetModal() {
            document.getElementById('set-target-modal').style.display = 'flex';
        }

        // إغلاق نافذة تعيين الهدف
        function closeTargetModal() {
            document.getElementById('set-target-modal').style.display = 'none';
        }

        // تعيين الهدف
        function setTarget() {
            const targetInput = document.getElementById('target-input');
            const targetValue = parseInt(targetInput.value);
            
            if (targetValue && targetValue > 0) {
                appData.target = targetValue;
                updateTargetDisplay();
                showToast('تم تعيين الهدف بنجاح');
                closeTargetModal();
                saveData();
            } else {
                showToast('يرجى إدخال رقم صحيح');
            }
        }

        // عرض نافذة إضافة ذكر جديد
        function showAddDhikrModal() {
            document.getElementById('add-dhikr-modal').style.display = 'flex';
        }

        // إغلاق نافذة إضافة ذكر جديد
        function closeAddDhikrModal() {
            document.getElementById('add-dhikr-modal').style.display = 'none';
        }

        // إضافة ذكر جديد
        function addNewDhikr() {
            const newDhikrName = document.getElementById('new-dhikr-name').value.trim();
            
            if (newDhikrName) {
                // التحقق من عدم وجود ذكر بنفس الاسم
                if (dhikrData.some(d => d.name === newDhikrName)) {
                    showToast('هذا الذكر موجود مسبقاً');
                    return;
                }
                
                // إضافة الذكر الجديد
                const newId = dhikrData.length > 0 ? Math.max(...dhikrData.map(d => d.id)) + 1 : 1;
                dhikrData.push({
                    id: newId,
                    name: newDhikrName,
                    arabic: newDhikrName,
                    count: 0
                });
                
                // إعادة عرض قائمة الأذكار
                renderDhikrList();
                
                showToast('تم إضافة الذكر بنجاح');
                closeAddDhikrModal();
                saveData();
            } else {
                showToast('يرجى إدخال اسم الذكر');
            }
        }

        // عرض نافذة تأكيد التصفير
        function showResetConfirmModal() {
            document.getElementById('reset-confirm-modal').style.display = 'flex';
        }

        // إغلاق نافذة تأكيد التصفير
        function closeResetConfirmModal() {
            document.getElementById('reset-confirm-modal').style.display = 'none';
        }

        // تصفير العداد
        function resetCounter() {
            appData.counter = 0;
            updateCounterDisplay();
            closeResetConfirmModal();
            saveData();
        }

        // عرض رسالة toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // عرض قائمة الأذكار
        function renderDhikrList() {
            const dhikrList = document.getElementById('dhikr-list');
            dhikrList.innerHTML = '';
            
            dhikrData.forEach(dhikr => {
                const dhikrItem = document.createElement('div');
                dhikrItem.className = 'dua-category-item';
                dhikrItem.innerHTML = `
                    <span>${dhikr.name}</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                `;
                
                dhikrItem.addEventListener('click', () => {
                    appData.currentDhikr = dhikr.name;
                    updateCounterDisplay();
                    closeDhikrModal();
                    showToast(`تم اختيار ${dhikr.name}`);
                });
                
                dhikrList.appendChild(dhikrItem);
            });
        }

        // تحميل فئات الأدعية من البيانات المحلية
        function loadDuasCategories() {
            renderLocalDuasCategories();
        }

        // عرض فئات الأدعية المحلية
        function renderLocalDuasCategories() {
            const duasCategoryList = document.getElementById('duas-category-list');
            duasCategoryList.innerHTML = '';
            
            localDuasData.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'dua-category-item';
                categoryItem.innerHTML = `
                    <span>${category.name}</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                `;
                
                categoryItem.addEventListener('click', () => {
                    showLocalDuasInCategory(category);
                });
                
                duasCategoryList.appendChild(categoryItem);
            });
        }

        // عرض الأدعية المحلية في فئة محددة
        function showLocalDuasInCategory(category) {
            const duasCategoryList = document.getElementById('duas-category-list');
            duasCategoryList.innerHTML = '';
            
            // إضافة زر الرجوع
            const backButton = document.createElement('div');
            backButton.className = 'dua-category-item';
            backButton.innerHTML = `
                <span>رجوع</span>
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            `;
            backButton.addEventListener('click', () => {
                renderLocalDuasCategories();
            });
            duasCategoryList.appendChild(backButton);
            
            // عرض الأدعية
            category.duas.forEach(dua => {
                const duaItem = document.createElement('div');
                duaItem.className = 'dua-category-item';
                duaItem.style.flexDirection = 'column';
                duaItem.style.alignItems = 'flex-end';
                duaItem.innerHTML = `
                    <div style="font-size: 1.2rem; margin-bottom: 10px; text-align: right; line-height: 1.6;">${dua.arabic}</div>
                    <div style="font-size: 0.9rem; color: var(--theme-accent); opacity: 0.8; text-align: right;">${dua.translation}</div>
                `;
                
                // إضافة زر النسخ
                const copyButton = document.createElement('button');
                copyButton.className = 'base-control';
                copyButton.style.marginTop = '10px';
                copyButton.style.padding = '5px 10px';
                copyButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    نسخ النص
                `;
                
                copyButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(dua.arabic).then(() => {
                        showToast('تم نسخ الدعاء');
                    });
                });
                
                duaItem.appendChild(copyButton);
                duasCategoryList.appendChild(duaItem);
            });
        }

        // تحميل سور القرآن من API
        async function loadQuranSurahs() {
            const quranSurahList = document.getElementById('quran-surah-list');
            quranSurahList.innerHTML = '<div style="text-align: center; padding: 20px;"><span class="loading-spinner"></span> جاري تحميل السور...</div>';
            
            try {
                const response = await fetch(`${QURAN_API_BASE}/surah`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    renderQuranSurahs(data.data);
                } else {
                    throw new Error('Failed to load Quran data');
                }
            } catch (error) {
                console.error('Error loading Quran surahs:', error);
                quranSurahList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--theme-accent);">عذراً، تعذر تحميل السور. يرجى المحاولة لاحقاً.</div>';
            }
        }

        // عرض قائمة السور القرآنية
        function renderQuranSurahs(surahs) {
            const quranSurahList = document.getElementById('quran-surah-list');
            quranSurahList.innerHTML = '';
            
            surahs.forEach(surah => {
                const surahItem = document.createElement('div');
                surahItem.className = 'quran-surah-item';
                surahItem.innerHTML = `
                    <span>${surah.number}. ${surah.englishName} - ${surah.name}</span>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                `;
                
                surahItem.addEventListener('click', () => {
                    showSurahAyat(surah);
                });
                
                quranSurahList.appendChild(surahItem);
            });
        }

        // عرض آيات السورة
        async function showSurahAyat(surah) {
            appData.selectedSurah = surah;
            appData.currentAyah = 1;
            
            const quranSurahList = document.getElementById('quran-surah-list');
            const quranReaderView = document.getElementById('quran-reader-view');
            
            quranSurahList.style.display = 'none';
            quranReaderView.style.display = 'flex';
            
            // إخفاء شريط التبويبات وإظهار الأزرار العائمة
            document.getElementById('tab-bar').classList.add('hidden');
            document.getElementById('quran-exit-button').style.display = 'flex';
            document.getElementById('quran-floating-buttons').style.display = 'flex';
            
            try {
                // تحميل النص العربي
                const arabicResponse = await fetch(`${QURAN_API_BASE}/surah/${surah.number}/ar.alafasy`);
                const arabicData = await arabicResponse.json();
                
                if (arabicData.code === 200 && arabicData.data) {
                    appData.selectedSurah.ayahs = arabicData.data.ayahs;
                    displayQuranPage();
                } else {
                    throw new Error('Failed to load surah content');
                }
            } catch (error) {
                console.error('Error loading surah content:', error);
                document.getElementById('quran-page').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--theme-accent);">عذراً، تعذر تحميل الآيات. يرجى المحاولة لاحقاً.</div>';
            }
        }

        // الخروج من عرض السورة
        function exitQuranView() {
            appData.selectedSurah = null;
            document.getElementById('quran-reader-view').style.display = 'none';
            document.getElementById('quran-surah-list').style.display = 'block';
            document.getElementById('tab-bar').classList.remove('hidden');
            document.getElementById('quran-exit-button').style.display = 'none';
            document.getElementById('quran-floating-buttons').style.display = 'none';
        }

        // عرض صفحة القرآن
        function displayQuranPage() {
            const quranPage = document.getElementById('quran-page');
            const surah = appData.selectedSurah;
            
            if (!surah || !surah.ayahs) return;
            
            let pageContent = `
                <div class="quran-page-header">
                    <div class="quran-surah-name">${surah.name}</div>
                    <div class="quran-surah-info">سورة ${surah.englishName} - ${surah.number}</div>
                </div>
                <div class="quran-ayat-container">
            `;
            
            // عرض الآيات من الآية الحالية
            const startAyah = appData.currentAyah;
            const endAyah = Math.min(startAyah + 9, surah.ayahs.length);
            
            for (let i = startAyah; i <= endAyah; i++) {
                const ayah = surah.ayahs[i-1];
                const isBookmarked = appData.bookmarkedAyat.some(b => b.surahId === surah.number && b.ayahId === ayah.numberInSurah);
                
                pageContent += `
                    <div class="quran-ayat ${isBookmarked ? 'bookmarked' : ''}">
                        <span class="quran-ayat-number">${ayah.numberInSurah}</span>
                        ${ayah.text}
                    </div>
                `;
            }
            
            pageContent += `
                </div>
                <div class="quran-page-footer">
                    الآيات ${startAyah} - ${endAyah} من ${surah.ayahs.length}
                </div>
            `;
            
            quranPage.innerHTML = pageContent;
            
            // تحديث أزرار التنقل
            document.getElementById('prev-ayah-button').disabled = appData.currentAyah === 1;
            document.getElementById('next-ayah-button').disabled = appData.currentAyah + 10 > surah.ayahs.length;
            
            // حفظ الموضع الحالي
            appData.lastReadPosition = {
                surahId: surah.number,
                ayahId: appData.currentAyah
            };
            saveData();
        }

        // حفظ الموضع الحالي
        function bookmarkCurrentPosition() {
            if (appData.selectedSurah) {
                // إزالة أي إشارة سابقة لنفس السورة
                appData.bookmarkedAyat = appData.bookmarkedAyat.filter(b => b.surahId !== appData.selectedSurah.number);
                
                // إضافة الإشارة الجديدة
                appData.bookmarkedAyat.push({
                    surahId: appData.selectedSurah.number,
                    ayahId: appData.currentAyah,
                    timestamp: new Date().toISOString()
                });
                
                saveData();
                showToast('تم حفظ الموضع الحالي');
                
                // تحديث عرض الصفحة
                displayQuranPage();
            }
        }

        // الانتقال إلى الآية السابقة
        function goToPrevAyah() {
            if (appData.currentAyah > 1) {
                appData.currentAyah = Math.max(1, appData.currentAyah - 10);
                displayQuranPage();
            }
        }

        // الانتقال إلى الآية التالية
        function goToNextAyah() {
            const surah = appData.selectedSurah;
            if (surah && appData.currentAyah + 10 <= surah.ayahs.length) {
                appData.currentAyah += 10;
                displayQuranPage();
            }
        }

        // الانتقال السريع إلى الموضع المحفوظ
        function quickJumpToBookmark() {
            if (appData.lastReadPosition && appData.selectedSurah) {
                // إذا كنا في نفس السورة، انتقل إلى الموضع المحفوظ
                if (appData.lastReadPosition.surahId === appData.selectedSurah.number) {
                    appData.currentAyah = appData.lastReadPosition.ayahId;
                    displayQuranPage();
                    showToast('تم الانتقال إلى آخر موضع قمت بقراءته');
                } else {
                    // إذا كنا في سورة مختلفة، انتقل إلى السورة المحفوظة
                    loadSurahById(appData.lastReadPosition.surahId);
                }
            } else {
                showToast('لا يوجد موضع محفوظ');
            }
        }

        // تحميل سورة بالرقم
        async function loadSurahById(surahId) {
            try {
                const response = await fetch(`${QURAN_API_BASE}/surah/${surahId}`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    showSurahAyat(data.data);
                }
            } catch (error) {
                console.error('Error loading surah by ID:', error);
                showToast('عذراً، تعذر تحميل السورة');
            }
        }

        // تحميل مواقيت الصلاة
        async function loadPrayerTimes() {
            const locationInfo = document.getElementById('location-info');
            const prayerTimesGrid = document.getElementById('prayer-times-grid');
            
            locationInfo.innerHTML = '<span class="loading-spinner"></span> جاري تحديد الموقع...';
            prayerTimesGrid.innerHTML = '';
            
            try {
                // الحصول على الموقع الجغرافي
                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;
                
                // جلب مواقيت الصلاة
                const today = new Date();
                const dateString = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
                
                const response = await fetch(`${PRAYER_API_BASE}/timings/${dateString}?latitude=${latitude}&longitude=${longitude}&method=2`);
                const data = await response.json();
                
                if (data.code === 200) {
                    displayPrayerTimes(data.data, latitude, longitude);
                } else {
                    throw new Error('Failed to load prayer times');
                }
            } catch (error) {
                console.error('Error loading prayer times:', error);
                locationInfo.innerHTML = 'تعذر تحديد الموقع. تأكد من تفعيل خدمة الموقع';
                prayerTimesGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--theme-accent);">عذراً، تعذر تحميل مواقيت الصلاة. يرجى المحاولة لاحقاً.</div>';
            }
        }

        // الحصول على الموقع الحالي
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        // عرض مواقيت الصلاة
        function displayPrayerTimes(prayerData, lat, lng) {
            const locationInfo = document.getElementById('location-info');
            const prayerTimesGrid = document.getElementById('prayer-times-grid');
            const timings = prayerData.timings;
            
            // تحديث معلومات الموقع
            locationInfo.textContent = `موقعك الحالي: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // تعريف أوقات الصلوات
            const prayers = [
                { name: 'الفجر', time: timings.Fajr, key: 'Fajr' },
                { name: 'الشروق', time: timings.Sunrise, key: 'Sunrise' },
                { name: 'الظهر', time: timings.Dhuhr, key: 'Dhuhr' },
                { name: 'العصر', time: timings.Asr, key: 'Asr' },
                { name: 'المغرب', time: timings.Maghrib, key: 'Maghrib' },
                { name: 'العشاء', time: timings.Isha, key: 'Isha' }
            ];
            
            // الحصول على الوقت الحالي
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            let nextPrayerIndex = -1;
            
            // البحث عن الصلاة التالية
            prayers.forEach((prayer, index) => {
                const [hours, minutes] = prayer.time.split(':');
                const prayerTime = parseInt(hours) * 60 + parseInt(minutes);
                
                if (prayerTime > currentTime && nextPrayerIndex === -1) {
                    nextPrayerIndex = index;
                }
            });
            
            // إذا لم نجد صلاة تالية، نعرض أول صلاة في اليوم التالي
            if (nextPrayerIndex === -1) {
                nextPrayerIndex = 0;
            }
            
            // عرض مواقيت الصلاة
            prayerTimesGrid.innerHTML = '';
            prayers.forEach((prayer, index) => {
                const isActive = index === nextPrayerIndex;
                const formattedTime = formatPrayerTime(prayer.time);
                
                const prayerCard = document.createElement('div');
                prayerCard.className = `prayer-time-card ${isActive ? 'active' : ''}`;
                prayerCard.innerHTML = `
                    <div class="prayer-name">${prayer.name}</div>
                    <div class="prayer-time">${formattedTime}</div>
                `;
                
                prayerTimesGrid.appendChild(prayerCard);
            });
        }

        // تنسيق وقت الصلاة
        function formatPrayerTime(time) {
            if (appData.timeFormat === '12') {
                // تحويل إلى تنسيق 12 ساعة
                const [hours, minutes] = time.split(':');
                let hour = parseInt(hours);
                const ampm = hour >= 12 ? 'م' : 'ص';
                hour = hour % 12 || 12;
                return `${hour}:${minutes} ${ampm}`;
            } else {
                // تنسيق 24 ساعة
                return time;
            }
        }

        // تغيير تنسيق الوقت
        function changeTimeFormat(format, button) {
            appData.timeFormat = format;
            
            // تحديث الأزرار النشطة
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // إعادة تحميل مواقيت الصلاة
            loadPrayerTimes();
            saveData();
        }

        // تصفير عدد الأذكار اليومية
        function resetTodayCount() {
            const todayCount = document.getElementById('today-count');
            todayCount.textContent = '0';
            localStorage.setItem('todayCount', '0');
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            // إجمالي الأذكار
            const totalCount = dhikrData.reduce((sum, dhikr) => sum + dhikr.count, 0);
            document.getElementById('total-count').textContent = totalCount;
            
            // الأذكار المكتملة (التي وصلت إلى الهدف)
            const completedDhikr = dhikrData.filter(d => d.count >= (appData.target || 1)).length;
            document.getElementById('completed-dhikr').textContent = completedDhikr;
            
            // الآيات المحددة
            document.getElementById('bookmarked-ayat').textContent = appData.bookmarkedAyat.length;
            
            // الأذكار اليومية (نموذج مبسط)
            const todayCount = parseInt(localStorage.getItem('todayCount') || '0') + appData.counter;
            document.getElementById('today-count').textContent = todayCount;
        }

        // تحديث تقدم الهدف
        function updateGoalProgress() {
            const progressBar = document.getElementById('goal-progress-bar');
            const progressText = document.getElementById('goal-progress-text');
            const percentage = document.getElementById('goal-percentage');
            
            const progress = Math.min(appData.counter / appData.dailyGoal, 1);
            const progressPercent = Math.round(progress * 100);
            
            progressBar.style.width = `${progressPercent}%`;
            progressText.textContent = `${appData.counter} / ${appData.dailyGoal}`;
            percentage.textContent = `${progressPercent}%`;
        }

        // عرض الإنجازات
        function renderAchievements() {
            const achievementsList = document.getElementById('achievements-list');
            achievementsList.innerHTML = '';
            
            appData.achievements.forEach(achievement => {
                const achievementBadge = document.createElement('div');
                achievementBadge.className = 'achievement-badge';
                achievementBadge.innerHTML = `
                    <span>${achievement.name}</span>
                    <span>${achievement.completed ? '✓' : ''}</span>
                `;
                
                if (!achievement.completed) {
                    achievementBadge.style.backgroundColor = 'var(--theme-secondary)';
                    achievementBadge.style.opacity = '0.7';
                }
                
                achievementsList.appendChild(achievementBadge);
            });
        }

        // التحقق من الإنجازات
        function checkAchievements() {
            const totalCount = dhikrData.reduce((sum, dhikr) => sum + dhikr.count, 0);
            const bookmarkedCount = appData.bookmarkedAyat.length;
            
            appData.achievements.forEach(achievement => {
                if (!achievement.completed) {
                    if (achievement.id <= 4 && totalCount >= achievement.target) {
                        achievement.completed = true;
                        showToast(`🎉 مبروك! لقد حصلت على إنجاز ${achievement.name}`);
                    } else if (achievement.id >= 5 && bookmarkedCount >= achievement.target) {
                        achievement.completed = true;
                        showToast(`🎉 مبروك! لقد حصلت على إنجاز ${achievement.name}`);
                    }
                }
            });
            
            renderAchievements();
            saveData();
        }

        // تصفية الأدعية
        function filterDuas() {
            const searchTerm = document.getElementById('duas-search-input').value.toLowerCase();
            const categoryItems = document.querySelectorAll('.dua-category-item');
            
            categoryItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // تصفية القرآن
        function filterQuran() {
            const searchTerm = document.getElementById('quran-search-input').value.toLowerCase();
            const surahItems = document.querySelectorAll('.quran-surah-item');
            
            surahItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // تبديل مؤقت الورد اليومي
        function toggleTimer() {
            const startButton = document.getElementById('start-timer-button');
            
            if (!appData.timerRunning) {
                // بدء المؤقت
                appData.timerRunning = true;
                startButton.textContent = 'إيقاف';
                
                appData.timerInterval = setInterval(() => {
                    appData.timerSeconds++;
                    updateDailyTimerDisplay();
                    saveData();
                }, 1000);
            } else {
                // إيقاف المؤقت
                appData.timerRunning = false;
                startButton.textContent = 'بدء';
                clearInterval(appData.timerInterval);
            }
        }

        // إعادة تعيين المؤقت
        function resetTimer() {
            appData.timerRunning = false;
            appData.timerSeconds = 0;
            clearInterval(appData.timerInterval);
            document.getElementById('start-timer-button').textContent = 'بدء';
            updateDailyTimerDisplay();
            saveData();
        }

        // تحديث عرض المؤقت اليومي
        function updateDailyTimerDisplay() {
            const timerDisplay = document.getElementById('daily-timer');
            const hours = Math.floor(appData.timerSeconds / 3600);
            const minutes = Math.floor((appData.timerSeconds % 3600) / 60);
            const seconds = appData.timerSeconds % 60;
            
            timerDisplay.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // تبديل الوضع الليلي
        function toggleDarkMode() {
            document.body.classList.toggle('light-mode');
            saveData();
        }

        // تبديل الاهتزاز
        function toggleVibration() {
            // يتم التعامل مع هذا في دالة incrementCounter
            saveData();
        }

        // تبديل اللغة الإنجليزية
        function toggleEnglish() {
            appData.isEnglishEnabled = document.getElementById('english-toggle').checked;
            
            if (appData.isEnglishEnabled) {
                showToast('English language enabled');
                // هنا يمكن إضافة ترجمة للواجهة
            } else {
                showToast('English language disabled');
            }
            
            saveData();
        }

        // تعيين الهدف اليومي
        function setDailyGoal() {
            const goalInput = document.getElementById('daily-goal-input');
            const goalValue = parseInt(goalInput.value);
            
            if (goalValue && goalValue > 0) {
                appData.dailyGoal = goalValue;
                updateGoalProgress();
                showToast('تم تعيين الهدف اليومي بنجاح');
                saveData();
            }
        }

        // تغيير الثيم
        function changeTheme(theme) {
            // إزالة جميع ثيمات الألوان
            document.body.classList.remove('theme-purple', 'theme-blue', 'theme-green', 'theme-rose', 'theme-sand', 'theme-ocean');
            
            // إضافة الثيم المحدد إذا لم يكن الافتراضي
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // تحديث الأزرار النشطة
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');
            
            saveData();
        }
    </script>
</body>
</html>
