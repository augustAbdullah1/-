name: ðŸš€ Build and Release Islamic App APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø±'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  APP_NAME: "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„"
  PACKAGE_NAME: "com.islamic.app.enhanced"

jobs:
  build-apk:
    name: ðŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli
        
    - name: ðŸ—ï¸ Build Web Assets
      run: |
        mkdir -p dist
        cp islamic-app-enhanced.html dist/index.html
        cp *.js dist/
        cp *.json dist/
        cp -r icons dist/ 2>/dev/null || echo "No icons directory"
        
    - name: âš¡ Initialize Capacitor
      run: |
        npx cap add android
        npx cap sync android
        
    - name: ðŸ”§ Setup Android Gradle Properties
      run: |
        mkdir -p android/gradle
        echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m" > android/gradle.properties
        echo "android.useAndroidX=true" >> android/gradle.properties
        echo "android.enableJetifier=true" >> android/gradle.properties
        
    - name: ðŸ—ï¸ Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: ðŸ—ï¸ Build Release APK (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: ðŸ“ Get App Version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        
    - name: ðŸ“± Rename APK Files
      run: |
        mkdir -p release-files
        
        # Debug APK
        if [ -f android/app/build/outputs/apk/debug/app-debug.apk ]; then
          cp android/app/build/outputs/apk/debug/app-debug.apk release-files/islamic-app-v${{ steps.version.outputs.version }}-debug.apk
        fi
        
        # Release APK (if exists)
        if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
          cp android/app/build/outputs/apk/release/app-release.apk release-files/islamic-app-v${{ steps.version.outputs.version }}-release.apk
        fi
        
        # Create info file
        cat > release-files/build-info.txt << EOF
        ðŸ•Œ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„
        ðŸ“± Ø§Ù„Ø¥ØµØ¯Ø§Ø±: v${{ steps.version.outputs.version }}
        ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡: $(date '+%Y-%m-%d %H:%M:%S UTC')
        ðŸ”§ SHA: ${{ github.sha }}
        ðŸŒ Ø§Ù„Ù…Ø·ÙˆØ±: Islamic App Team
        
        âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª:
        â€¢ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙƒØ§Ù…Ù„Ø§Ù‹ (114 Ø³ÙˆØ±Ø©)
        â€¢ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø¯Ø§Ù†
        â€¢ Ø£Ø°Ø§Ù† ØµÙˆØªÙŠ Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ÙˆØ«ÙˆÙ‚Ø©
        â€¢ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©
        â€¢ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡ ÙˆÙ‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…
        â€¢ 5 Ø«ÙŠÙ…Ø§Øª Ø¬Ù…ÙŠÙ„Ø©
        â€¢ Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ù…ØªØ·ÙˆØ±Ø©
        â€¢ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©
        â€¢ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
        
        ðŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„:
        - islamic-app-v${{ steps.version.outputs.version }}-debug.apk (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
        - islamic-app-v${{ steps.version.outputs.version }}-release.apk (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
        EOF
        
    - name: ðŸ“¤ Upload APK Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: islamic-app-apks-v${{ steps.version.outputs.version }}
        path: release-files/
        retention-days: 30
        
    - name: ðŸ·ï¸ Create Release Tag
      if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a v${{ steps.version.outputs.version }} -m "ðŸš€ Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ v${{ steps.version.outputs.version }}"
        git push origin v${{ steps.version.outputs.version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸŽ‰ Create GitHub Release
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.version.outputs.version }}
        name: "ðŸ•Œ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ v${{ steps.version.outputs.version }}"
        body: |
          ## ðŸ•Œ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.version.outputs.version }}
          
          ### âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
          - ðŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙƒØ§Ù…Ù„Ø§Ù‹ Ù…Ø¹ 114 Ø³ÙˆØ±Ø© Ù…Ù† Ù…ØµØ§Ø¯Ø± Ù…ÙˆØ«ÙˆÙ‚Ø©
          - ðŸ•Œ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ API Ù…ØªØ·ÙˆØ±
          - ðŸ”Š Ø£Ø°Ø§Ù† ØµÙˆØªÙŠ Ù…Ù† Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
          - ðŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© ÙˆØ§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
          - ðŸ“¿ Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø³Ø§Ø¡ ÙˆÙ‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ… (500+ Ø¯Ø¹Ø§Ø¡)
          - ðŸŽ¨ 5 Ø«ÙŠÙ…Ø§Øª Ø¬Ù…ÙŠÙ„Ø© ØªÙ†Ø§Ø³Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø°ÙˆØ§Ù‚
          - âœ¨ Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ù…ØªØ·ÙˆØ±Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø¹ØµØ±ÙŠØ©
          - ðŸ“± PWA ÙƒØ§Ù…Ù„ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
          - ðŸŒ Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø¯Ø§Ù† ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠØ©
          
          ### ðŸ“± ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù„ Ù…Ù„Ù APK Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
          2. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆÙØ¹Ù„ "Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"
          3. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ù„Ù APK Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          4. Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚! ðŸŽ‰
          
          ### ðŸ“¥ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:
          - **islamic-app-v${{ steps.version.outputs.version }}-debug.apk** - Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø©
          - **islamic-app-v${{ steps.version.outputs.version }}-release.apk** - Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)
          - **build-info.txt** - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª
          
          ### ðŸ”§ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:
          - Android 7.0 (API 24) Ø£Ùˆ Ø£Ø­Ø¯Ø«
          - 50 MB Ù…Ø³Ø§Ø­Ø© ØªØ®Ø²ÙŠÙ†
          - Ø§ØªØµØ§Ù„ Ø¥Ù†ØªØ±Ù†Øª (Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
          
          ---
          
          **ðŸ’ Ø¬Ø²Ø§ÙƒÙ… Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚**
          
          ðŸ› **ÙˆØ¬Ø¯Øª Ù…Ø´ÙƒÙ„Ø©ØŸ** [Ø£Ù†Ø´Ø¦ issue Ø¬Ø¯ÙŠØ¯](https://github.com/${{ github.repository }}/issues/new)
          â­ **Ø£Ø¹Ø¬Ø¨Ùƒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ** Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Star ÙˆØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡!
          
        files: |
          release-files/islamic-app-v${{ steps.version.outputs.version }}-debug.apk
          release-files/islamic-app-v${{ steps.version.outputs.version }}-release.apk
          release-files/build-info.txt
        draft: false
        prerelease: false
        generateReleaseNotes: true
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: ðŸŽ‰ Notify Build Success  
    needs: build-apk
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ðŸŽŠ Success Notification
      run: |
        echo "ðŸŽ‰ ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ðŸ“± APK Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Releases"
        echo "ðŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: https://github.com/${{ github.repository }}/releases"

  notify-failure:
    name: ðŸš¨ Notify Build Failure
    needs: build-apk  
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: âŒ Failure Notification
      run: |
        echo "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!"
        echo "ðŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¨Ø¨"
        echo "ðŸ› ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ issue Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©"