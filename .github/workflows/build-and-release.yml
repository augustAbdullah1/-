name: 🚀 Build and Release Islamic App APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'نوع الإصدار'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  APP_NAME: "التطبيق الإسلامي الشامل"
  PACKAGE_NAME: "com.islamic.app.enhanced"

jobs:
  build-apk:
    name: 📱 Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: ☕ Setup Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: 📱 Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli
        
    - name: 🏗️ Build Web Assets
      run: |
        mkdir -p dist
        cp islamic-app-enhanced.html dist/index.html
        cp *.js dist/
        cp *.json dist/
        cp -r icons dist/ 2>/dev/null || echo "No icons directory"
        
    - name: ⚡ Initialize Capacitor
      run: |
        npx cap add android
        npx cap sync android
        
    - name: 🔧 Setup Android Gradle Properties
      run: |
        mkdir -p android/gradle
        echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m" > android/gradle.properties
        echo "android.useAndroidX=true" >> android/gradle.properties
        echo "android.enableJetifier=true" >> android/gradle.properties
        
    - name: 🏗️ Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --stacktrace
        
    - name: 🏗️ Build Release APK (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: 📝 Get App Version
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        
    - name: 📱 Rename APK Files
      run: |
        mkdir -p release-files
        
        # Debug APK
        if [ -f android/app/build/outputs/apk/debug/app-debug.apk ]; then
          cp android/app/build/outputs/apk/debug/app-debug.apk release-files/islamic-app-v${{ steps.version.outputs.version }}-debug.apk
        fi
        
        # Release APK (if exists)
        if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
          cp android/app/build/outputs/apk/release/app-release.apk release-files/islamic-app-v${{ steps.version.outputs.version }}-release.apk
        fi
        
        # Create info file
        cat > release-files/build-info.txt << EOF
        🕌 التطبيق الإسلامي الشامل
        📱 الإصدار: v${{ steps.version.outputs.version }}
        📅 تاريخ البناء: $(date '+%Y-%m-%d %H:%M:%S UTC')
        🔧 SHA: ${{ github.sha }}
        🌐 المطور: Islamic App Team
        
        ✨ الميزات:
        • القرآن الكريم كاملاً (114 سورة)
        • أوقات الصلاة الدقيقة لجميع البلدان
        • أذان صوتي من مصادر موثوقة
        • بوصلة القبلة الذكية
        • أذكار الصباح والمساء وقبل النوم
        • 5 ثيمات جميلة
        • رسوم متحركة متطورة
        • إشعارات أوقات الصلاة
        • يعمل أوفلاين
        
        📥 التحميل:
        - islamic-app-v${{ steps.version.outputs.version }}-debug.apk (للتجربة)
        - islamic-app-v${{ steps.version.outputs.version }}-release.apk (للاستخدام العادي)
        EOF
        
    - name: 📤 Upload APK Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: islamic-app-apks-v${{ steps.version.outputs.version }}
        path: release-files/
        retention-days: 30
        
    - name: 🏷️ Create Release Tag
      if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a v${{ steps.version.outputs.version }} -m "🚀 إصدار التطبيق الإسلامي v${{ steps.version.outputs.version }}"
        git push origin v${{ steps.version.outputs.version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🎉 Create GitHub Release
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.version.outputs.version }}
        name: "🕌 التطبيق الإسلامي الشامل v${{ steps.version.outputs.version }}"
        body: |
          ## 🕌 التطبيق الإسلامي الشامل - الإصدار ${{ steps.version.outputs.version }}
          
          ### ✨ الميزات الجديدة:
          - 📖 القرآن الكريم كاملاً مع 114 سورة من مصادر موثوقة
          - 🕌 أوقات الصلاة الدقيقة مع API متطور
          - 🔊 أذان صوتي من اليوتيوب مع إشعارات
          - 🧭 بوصلة القبلة الذكية والدقيقة
          - 📿 أذكار الصباح والمساء وقبل النوم (500+ دعاء)
          - 🎨 5 ثيمات جميلة تناسب جميع الأذواق
          - ✨ رسوم متحركة متطورة وواجهة عصرية
          - 📱 PWA كامل يعمل أوفلاين
          - 🌍 دعم جميع البلدان والمناطق الزمنية
          
          ### 📱 كيفية التثبيت:
          1. حمل ملف APK من الأسفل
          2. اذهب إلى إعدادات الأمان وفعل "مصادر غير معروفة"
          3. اضغط على ملف APK لتثبيت التطبيق
          4. استمتع بالتطبيق! 🎉
          
          ### 📥 الملفات المتاحة:
          - **islamic-app-v${{ steps.version.outputs.version }}-debug.apk** - للمطورين والتجربة
          - **islamic-app-v${{ steps.version.outputs.version }}-release.apk** - للاستخدام العادي (موصى به)
          - **build-info.txt** - معلومات البناء والميزات
          
          ### 🔧 متطلبات النظام:
          - Android 7.0 (API 24) أو أحدث
          - 50 MB مساحة تخزين
          - اتصال إنترنت (للمزامنة الأولى)
          
          ---
          
          **💝 جزاكم الله خيراً لاستخدام التطبيق**
          
          🐛 **وجدت مشكلة؟** [أنشئ issue جديد](https://github.com/${{ github.repository }}/issues/new)
          ⭐ **أعجبك التطبيق؟** اضغط على Star وشاركه مع الأصدقاء!
          
        files: |
          release-files/islamic-app-v${{ steps.version.outputs.version }}-debug.apk
          release-files/islamic-app-v${{ steps.version.outputs.version }}-release.apk
          release-files/build-info.txt
        draft: false
        prerelease: false
        generateReleaseNotes: true
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: 🎉 Notify Build Success  
    needs: build-apk
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: 🎊 Success Notification
      run: |
        echo "🎉 تم بناء التطبيق الإسلامي بنجاح!"
        echo "📱 APK جاهز للتحميل في Releases"
        echo "🔗 الرابط: https://github.com/${{ github.repository }}/releases"

  notify-failure:
    name: 🚨 Notify Build Failure
    needs: build-apk  
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: ❌ Failure Notification
      run: |
        echo "❌ فشل في بناء التطبيق!"
        echo "🔍 تحقق من سجلات البناء لمعرفة السبب"
        echo "🐛 يرجى إنشاء issue إذا استمرت المشكلة"